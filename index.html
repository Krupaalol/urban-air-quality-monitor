<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Environmental Monitoring System | CS7NS4</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <!-- Visualization Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* Professional Research Tool Design */
        :root {
            --primary: #1a1a1a;
            --secondary: #4a4a4a;
            --border: #d0d0d0;
            --bg: #ffffff;
            --bg-alt: #f5f5f5;
            --text: #1a1a1a;
            --text-light: #6a6a6a;
            --accent: #2d5f8d;
            --success: #2e7d32;
            --warning: #c77700;
            --danger: #c62828;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-alt);
            color: var(--text);
            line-height: 1.5;
            font-size: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1540px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.7;
            font-weight: 300;
        }

        .system-info {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            font-size: 12px;
            opacity: 0.8;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Controls */
        .controls {
            padding: 15px 30px;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
        }

        .controls-content {
            max-width: 1540px;
            margin: 0 auto;
            display: flex;
            gap: 8px;
        }

        button {
            padding: 8px 18px;
            font-size: 13px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-weight: 400;
            transition: all 0.15s;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            border-color: var(--secondary);
        }

        #startBtn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #startBtn:hover:not(:disabled) {
            background: var(--secondary);
        }

        #stopBtn {
            border-color: var(--danger);
            color: var(--danger);
        }

        #stopBtn:hover:not(:disabled) {
            background: var(--danger);
            color: white;
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Dashboard Stats */
        .dashboard {
            padding: 20px 30px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .dashboard-content {
            max-width: 1540px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .stat {
            background: var(--bg-alt);
            padding: 12px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 400;
            color: var(--text);
            font-variant-numeric: tabular-nums;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .content-panel {
            border-right: 1px solid var(--border);
        }

        .sidebar-panel {
            background: var(--bg-alt);
        }

        /* Sections */
        .section {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
        }

        .section-header {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Map */
        #map {
            height: 400px;
            border: 1px solid var(--border);
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border: 1px solid var(--border);
            border-top: none;
        }

        .chart-box {
            padding: 20px;
            border-right: 1px solid var(--border);
            background: var(--bg);
        }

        .chart-box:last-child {
            border-right: none;
        }

        .chart-title {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .chart-container {
            position: relative;
            height: 180px;
        }

        /* Sidebar Items */
        .info-block {
            background: var(--bg);
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            font-size: 13px;
        }

        .info-block-header {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .info-block-content {
            color: var(--text-light);
            font-size: 12px;
        }

        .poi-list {
            list-style: none;
        }

        .poi-item {
            padding: 10px;
            margin-bottom: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-left: 2px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .poi-school { border-left-color: var(--warning); }
        .poi-hospital { border-left-color: var(--danger); }
        .poi-park { border-left-color: var(--success); }

        /* Data Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--bg-alt);
            padding: 8px 10px;
            text-align: left;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            color: var(--text-light);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg-alt);
        }

        /* Alerts */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 350px;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.2s;
            font-size: 13px;
            border-left: 3px solid;
        }

        .alert.show {
            opacity: 1;
            transform: translateX(0);
        }

        .alert-success { border-left-color: var(--success); }
        .alert-danger { border-left-color: var(--danger); }
        .alert-warning { border-left-color: var(--warning); }
        .alert-info { border-left-color: var(--accent); }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .content-panel {
                border-right: none;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-box {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .header, .controls, .dashboard, .section {
                padding-left: 15px;
                padding-right: 15px;
            }

            .controls-content {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Urban Environmental Monitoring System</h1>
                <p>Real-time Air Quality Intelligence | CS7NS4 Assignment 4</p>
                <div class="system-info">
                    <div class="info-item"><span id="cloudStatus">‚óè Cloud Database</span></div>
                    <div class="info-item"><span>Multi-User</span></div>
                    <div class="info-item"><span>Live GPS</span></div>
                    <div class="info-item"><span>Weather API</span></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-content">
                <button id="startBtn">Start Monitoring</button>
                <button id="stopBtn" disabled>Stop Monitoring</button>
                <button id="downloadBtn">Export Data (CSV)</button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="dashboard-content">
                <div class="stat">
                    <div class="stat-label">Local Records</div>
                    <div class="stat-value" id="recordCount">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Cloud Records</div>
                    <div class="stat-value" id="cloudCount">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Temperature</div>
                    <div class="stat-value" id="currentTemp">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Air Quality</div>
                    <div class="stat-value" id="currentAQI" style="color: var(--accent)">--</div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Content Panel -->
            <div class="content-panel">
                <!-- Map Section -->
                <div class="section">
                    <div class="section-header">Geographic Tracking</div>
                    <div id="map"></div>
                </div>

                <!-- Charts Section -->
                <div class="section" style="padding: 0;">
                    <div class="charts-grid">
                        <div class="chart-box">
                            <div class="chart-title">Weather Conditions</div>
                            <div class="chart-container">
                                <canvas id="weatherChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title">Heat Island Detection</div>
                            <div class="chart-container">
                                <canvas id="heatChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title">Air Quality Index</div>
                            <div class="chart-container">
                                <canvas id="aqiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table Section -->
                <div class="section">
                    <div class="section-header">Recent Measurements</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Location</th>
                                    <th>Temp (¬∞C)</th>
                                    <th>AQI</th>
                                    <th>Heat Island</th>
                                    <th>Storage</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-light); padding: 20px;">No data collected yet. Start monitoring to begin.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sidebar Panel -->
            <div class="sidebar-panel">
                <!-- Heat Island Info -->
                <div class="section">
                    <div class="section-header">Heat Island Status</div>
                    <div id="heatIslandInfo">
                        <div class="info-block">
                            <div class="info-block-content">Awaiting data collection...</div>
                        </div>
                    </div>
                </div>

                <!-- POI Section -->
                <div class="section">
                    <div class="section-header">Nearby Locations</div>
                    <ul class="poi-list" id="poiList">
                        <li style="color: var(--text-light); font-size: 12px;">No nearby locations detected</li>
                    </ul>
                </div>

                <!-- Transit Section -->
                <div class="section">
                    <div class="section-header">Public Transit</div>
                    <div id="transitInfo">
                        <div class="info-block-content" style="color: var(--text-light); font-size: 12px;">Transit data will appear during monitoring</div>
                    </div>
                </div>

                <!-- Route Recommendations -->
                <div class="section">
                    <div class="section-header">Route Guidance</div>
                    <div id="routeRecommendations">
                        <div class="info-block-content" style="color: var(--text-light); font-size: 12px;">Recommendations will appear based on air quality</div>
                    </div>
                </div>

                <!-- Community Data -->
                <div class="section">
                    <div class="section-header">Community Readings</div>
                    <div id="communityReadings">
                        <div class="info-block-content" style="color: var(--text-light); font-size: 12px;">No community data available</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Box -->
    <div id="alertBox" class="alert"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3Jc0S1hajXnqHczmgZINO1XS1GVH7K4E",
            authDomain: "gps-data-urban-computing.firebaseapp.com",
            projectId: "gps-data-urban-computing",
            storageBucket: "gps-data-urban-computing.appspot.com",
            messagingSenderId: "696881519327",
            appId: "1:696881519327:web:36134020bd314c9a71a76a",
            measurementId: "G-ETBBD7GHVH"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Application State
        let isCollecting = false;
        let collectionInterval = null;
        let dataPoints = [];
        let map = null;
        let pathPolyline = null;
        let currentMarker = null;
        let poiMarkers = [];
        let cloudDataCount = 0;

        // Charts
        let weatherChart = null;
        let heatChart = null;
        let aqiChart = null;

        // User Identification
        function getUserId() {
            let userId = localStorage.getItem('urbanAQ_userId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('urbanAQ_userId', userId);
            }
            return userId;
        }

        const sessionId = 'session_' + Date.now();
        const userId = getUserId();

        // Dublin POIs
        const dublinPOIs = [
            { name: "Trinity College", type: "school", lat: 53.3438, lng: -6.2546 },
            { name: "St. James's Hospital", type: "hospital", lat: 53.3414, lng: -6.2935 },
            { name: "Phoenix Park", type: "park", lat: 53.3559, lng: -6.3298 },
            { name: "UCD", type: "school", lat: 53.3063, lng: -6.2206 },
            { name: "Mater Hospital", type: "hospital", lat: 53.3589, lng: -6.2618 },
            { name: "St. Stephen's Green", type: "park", lat: 53.3376, lng: -6.2597 }
        ];

        const transitStops = [
            { name: "O'Connell Street (LUAS)", lat: 53.3498, lng: -6.2603, type: "tram" },
            { name: "College Green (Bus)", lat: 53.3445, lng: -6.2597, type: "bus" },
            { name: "Connolly Station", lat: 53.3509, lng: -6.2500, type: "train" }
        ];

        // Map Initialization
        function initMap() {
            map = L.map('map').setView([53.3498, -6.2603], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            pathPolyline = L.polyline([], {
                color: '#2d5f8d',
                weight: 2,
                opacity: 0.7
            }).addTo(map);

            addPOIMarkers();
        }

        function addPOIMarkers() {
            const icons = {
                school: 'üè´',
                hospital: 'üè•',
                park: 'üå≥',
                bus: 'üöå',
                tram: 'üöä',
                train: 'üöÜ'
            };

            dublinPOIs.forEach(poi => {
                const icon = L.divIcon({
                    html: `<div style="font-size: 18px;">${icons[poi.type]}</div>`,
                    className: 'poi-marker',
                    iconSize: [24, 24]
                });

                const marker = L.marker([poi.lat, poi.lng], { icon })
                    .bindPopup(`<b>${poi.name}</b><br>${poi.type}`)
                    .addTo(map);
                
                poiMarkers.push({ marker, data: poi });
            });

            transitStops.forEach(stop => {
                const icon = L.divIcon({
                    html: `<div style="font-size: 18px;">${icons[stop.type]}</div>`,
                    className: 'transit-marker',
                    iconSize: [24, 24]
                });

                L.marker([stop.lat, stop.lng], { icon })
                    .bindPopup(`<b>${stop.name}</b>`)
                    .addTo(map);
            });
        }

        // Charts Initialization
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10 }, maxRotation: 0 }
                    }
                }
            };

            weatherChart = new Chart(document.getElementById('weatherChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature',
                        data: [],
                        borderColor: '#2d5f8d',
                        backgroundColor: 'rgba(45, 95, 141, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: chartOptions
            });

            heatChart = new Chart(document.getElementById('heatChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Deviation',
                        data: [],
                        borderColor: '#c77700',
                        backgroundColor: 'rgba(199, 119, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: chartOptions
            });

            aqiChart = new Chart(document.getElementById('aqiChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'AQI',
                        data: [],
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: chartOptions
            });
        }

        // Calculation Functions
        function calculateAQI(temp, windSpeed) {
            let baseAQI = 50;
            const tempDeviation = Math.abs(temp - 15);
            baseAQI += tempDeviation * 2;
            
            if (windSpeed < 2) baseAQI += 30;
            else if (windSpeed > 10) baseAQI += 20;
            
            baseAQI += Math.random() * 20 - 10;
            return Math.min(Math.max(Math.round(baseAQI), 0), 300);
        }

        function detectHeatIsland(temp) {
            const baselineTemp = 12;
            const deviation = temp - baselineTemp;
            const isHeatIsland = deviation > 3;
            
            return {
                isHeatIsland,
                deviation,
                severity: deviation > 5 ? 'High' : deviation > 3 ? 'Moderate' : 'Low'
            };
        }

        function getAQIInfo(aqi) {
            if (aqi <= 50) return { category: 'Good', color: '#2e7d32' };
            if (aqi <= 100) return { category: 'Moderate', color: '#c77700' };
            if (aqi <= 150) return { category: 'Unhealthy (Sensitive)', color: '#ff6f00' };
            if (aqi <= 200) return { category: 'Unhealthy', color: '#c62828' };
            return { category: 'Very Unhealthy', color: '#880e4f' };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function findNearestPOIs(lat, lng, aqi) {
            const affected = [];
            dublinPOIs.forEach(poi => {
                const distance = calculateDistance(lat, lng, poi.lat, poi.lng);
                if (distance < 1) {
                    affected.push({ ...poi, distance, aqi });
                }
            });
            return affected.slice(0, 5);
        }

        function findNearestTransit(lat, lng) {
            const nearest = [];
            transitStops.forEach(stop => {
                const distance = calculateDistance(lat, lng, stop.lat, stop.lng);
                if (distance < 0.5) {
                    nearest.push({ ...stop, distance });
                }
            });
            return nearest.slice(0, 3);
        }

        function generateRouteRecommendation(aqi) {
            if (aqi > 150) {
                return {
                    message: 'Consider using public transit to minimize outdoor exposure.',
                    suggestion: 'LUAS or bus recommended to reduce exposure time.'
                };
            } else if (aqi > 100) {
                return {
                    message: 'Route through parks recommended for better air quality.',
                    suggestion: 'Phoenix Park or St. Stephen\'s Green have better circulation.'
                };
            } else {
                return {
                    message: 'Air quality is acceptable. All routes are safe.',
                    suggestion: 'Walking or cycling is suitable under current conditions.'
                };
            }
        }

        // Alert System
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 4000);
        }

        // Weather API
        async function fetchWeatherData(lat, lng) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`;
                const response = await fetch(url);
                const data = await response.json();
                
                return {
                    temperature: data.current_weather.temperature,
                    windSpeed: data.current_weather.windspeed
                };
            } catch (error) {
                return {
                    temperature: 12 + Math.random() * 8,
                    windSpeed: 2 + Math.random() * 5
                };
            }
        }

        // Cloud Functions
        async function fetchCommunityDataFromCloud(userLat, userLng) {
            try {
                const oneHourAgo = new Date();
                oneHourAgo.setHours(oneHourAgo.getHours() - 1);

                const snapshot = await db.collection('urban_air_quality')
                    .where('timestamp', '>=', oneHourAgo.toISOString())
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                const communityData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const distance = calculateDistance(
                        userLat, userLng, 
                        data.latitude, data.longitude
                    );
                    
                    if (distance < 2 && data.userId !== userId) {
                        communityData.push({
                            ...data,
                            distance: distance,
                            minutesAgo: Math.floor((Date.now() - new Date(data.timestamp)) / 60000)
                        });
                    }
                });

                return communityData.slice(0, 5);
            } catch (error) {
                return [];
            }
        }

        async function getCloudRecordCount() {
            try {
                const snapshot = await db.collection('urban_air_quality')
                    .where('userId', '==', userId)
                    .where('sessionId', '==', sessionId)
                    .get();
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }

        // Data Collection
        async function collectData() {
            if (!navigator.geolocation) {
                showAlert('Geolocation not supported', 'danger');
                stopCollection();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const timestamp = new Date().toISOString();

                    const weather = await fetchWeatherData(lat, lng);
                    const aqi = calculateAQI(weather.temperature, weather.windSpeed);
                    const heatIsland = detectHeatIsland(weather.temperature);

                    const dataPoint = {
                        timestamp,
                        latitude: lat,
                        longitude: lng,
                        accuracy,
                        temperature: weather.temperature,
                        windSpeed: weather.windSpeed,
                        aqi: aqi,
                        heatIsland: heatIsland.isHeatIsland,
                        heatDeviation: heatIsland.deviation,
                        userId: userId,
                        sessionId: sessionId
                    };

                    try {
                        await db.collection('urban_air_quality').add(dataPoint);
                        cloudDataCount = await getCloudRecordCount();
                        document.getElementById('cloudCount').textContent = cloudDataCount;
                        showAlert('Data uploaded to cloud', 'success');
                    } catch (error) {
                        showAlert('Cloud upload failed, local storage continues', 'warning');
                    }

                    dataPoints.push(dataPoint);

                    updateStatus(dataPoint);
                    updateCharts(dataPoint);
                    updateMap(lat, lng, aqi);
                    await updateUrbanFeatures(lat, lng, aqi, weather.temperature);
                    updateTable();
                    checkAlerts(aqi, heatIsland);
                },
                (error) => {
                    showAlert('GPS error. Enable location services.', 'danger');
                }
            );
        }

        // UI Update Functions
        function updateStatus(dataPoint) {
            document.getElementById('recordCount').textContent = dataPoints.length;
            document.getElementById('currentTemp').textContent = dataPoint.temperature.toFixed(1) + '¬∞C';
            
            const aqiElement = document.getElementById('currentAQI');
            aqiElement.textContent = dataPoint.aqi;
            const aqiInfo = getAQIInfo(dataPoint.aqi);
            aqiElement.style.color = aqiInfo.color;
        }

        function updateCharts(dataPoint) {
            const timeLabel = new Date(dataPoint.timestamp).toLocaleTimeString();
            const maxPoints = 15;

            [weatherChart, heatChart, aqiChart].forEach(chart => {
                if (chart.data.labels.length > maxPoints) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
            });

            weatherChart.data.labels.push(timeLabel);
            weatherChart.data.datasets[0].data.push(dataPoint.temperature);
            weatherChart.update('none');

            heatChart.data.labels.push(timeLabel);
            heatChart.data.datasets[0].data.push(dataPoint.heatDeviation);
            heatChart.update('none');

            aqiChart.data.labels.push(timeLabel);
            aqiChart.data.datasets[0].data.push(dataPoint.aqi);
            aqiChart.update('none');
        }

        function updateMap(lat, lng, aqi) {
            pathPolyline.addLatLng([lat, lng]);
            
            const color = getAQIInfo(aqi).color;
            
            if (currentMarker) {
                currentMarker.setLatLng([lat, lng]);
                currentMarker.setStyle({ fillColor: color });
            } else {
                currentMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: color,
                    fillOpacity: 0.8,
                    color: '#fff',
                    weight: 2
                }).bindPopup(`<b>Location</b><br>AQI: ${aqi}<br>Cloud synced`)
                  .addTo(map);
            }
            
            map.setView([lat, lng], map.getZoom());
        }

        async function updateUrbanFeatures(lat, lng, aqi, temp) {
            // Heat Island
            const heatIsland = detectHeatIsland(temp);
            const heatDiv = document.getElementById('heatIslandInfo');
            
            if (heatIsland.isHeatIsland) {
                heatDiv.innerHTML = `
                    <div class="info-block">
                        <div class="info-block-header">Heat Island Detected</div>
                        <div class="info-block-content">+${heatIsland.deviation.toFixed(1)}¬∞C above baseline<br>Severity: ${heatIsland.severity}</div>
                    </div>
                `;
            } else {
                heatDiv.innerHTML = `
                    <div class="info-block">
                        <div class="info-block-header">Normal Temperature</div>
                        <div class="info-block-content">${heatIsland.deviation.toFixed(1)}¬∞C from baseline</div>
                    </div>
                `;
            }

            // POIs
            const nearbyPOIs = findNearestPOIs(lat, lng, aqi);
            const poiDiv = document.getElementById('poiList');
            
            if (nearbyPOIs.length > 0) {
                poiDiv.innerHTML = nearbyPOIs.map(poi => {
                    const aqiInfo = getAQIInfo(poi.aqi);
                    const icon = poi.type === 'school' ? 'üè´' : poi.type === 'hospital' ? 'üè•' : 'üå≥';
                    return `
                        <li class="poi-item poi-${poi.type}">
                            <span>${icon} ${poi.name} (${poi.distance.toFixed(1)}km)</span>
                            <span style="color: ${aqiInfo.color};">${poi.aqi}</span>
                        </li>
                    `;
                }).join('');
            } else {
                poiDiv.innerHTML = '<li style="color: var(--text-light); font-size: 12px; padding: 10px;">No nearby locations</li>';
            }

            // Transit
            const nearbyTransit = findNearestTransit(lat, lng);
            const transitDiv = document.getElementById('transitInfo');
            
            if (nearbyTransit.length > 0) {
                transitDiv.innerHTML = nearbyTransit.map(stop => {
                    const icon = stop.type === 'bus' ? 'üöå' : stop.type === 'tram' ? 'üöä' : 'üöÜ';
                    return `
                        <div class="info-block">
                            <div class="info-block-header">${icon} ${stop.name}</div>
                            <div class="info-block-content">${(stop.distance * 1000).toFixed(0)}m away</div>
                        </div>
                    `;
                }).join('');
            } else {
                transitDiv.innerHTML = '<div class="info-block-content" style="color: var(--text-light); font-size: 12px;">No transit nearby</div>';
            }

            // Community Data
            const cloudData = await fetchCommunityDataFromCloud(lat, lng);
            const communityDiv = document.getElementById('communityReadings');
            
            if (cloudData.length > 0) {
                communityDiv.innerHTML = cloudData.map(reading => {
                    const aqiInfo = getAQIInfo(reading.aqi);
                    return `
                        <div class="info-block">
                            <div class="info-block-header">Community Reading</div>
                            <div class="info-block-content">${(reading.distance * 1000).toFixed(0)}m ‚Ä¢ ${reading.minutesAgo}min ago<br>
                            AQI: <span style="color: ${aqiInfo.color}">${reading.aqi}</span> (${aqiInfo.category})</div>
                        </div>
                    `;
                }).join('');
            } else {
                communityDiv.innerHTML = '<div class="info-block-content" style="color: var(--text-light); font-size: 12px;">No community data nearby</div>';
            }

            // Route Recommendations
            const routeRec = generateRouteRecommendation(aqi);
            const routeDiv = document.getElementById('routeRecommendations');
            routeDiv.innerHTML = `
                <div class="info-block">
                    <div class="info-block-header">${routeRec.message}</div>
                    <div class="info-block-content">${routeRec.suggestion}</div>
                </div>
            `;
        }

        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const recentData = dataPoints.slice(-10).reverse();
            
            tbody.innerHTML = recentData.map(dp => {
                const aqiInfo = getAQIInfo(dp.aqi);
                const location = `${dp.latitude.toFixed(4)}, ${dp.longitude.toFixed(4)}`;
                return `
                    <tr>
                        <td>${new Date(dp.timestamp).toLocaleString()}</td>
                        <td>${location}</td>
                        <td>${dp.temperature.toFixed(1)}</td>
                        <td style="color: ${aqiInfo.color}">${dp.aqi}</td>
                        <td>${dp.heatIsland ? 'Yes' : 'No'}</td>
                        <td>Cloud + Local</td>
                    </tr>
                `;
            }).join('');
        }

        function checkAlerts(aqi, heatIsland) {
            const aqiInfo = getAQIInfo(aqi);
            
            if (aqi > 150) {
                showAlert(`Health Alert: ${aqiInfo.category} (AQI: ${aqi}). Consider transit.`, 'danger');
            } else if (aqi > 100) {
                showAlert(`Air Quality: ${aqiInfo.category} (AQI: ${aqi})`, 'warning');
            }

            if (heatIsland.isHeatIsland && heatIsland.severity === 'High') {
                showAlert(`Heat Island: +${heatIsland.deviation.toFixed(1)}¬∞C above normal`, 'warning');
            }
        }

        // Control Functions
        function startCollection() {
            if (isCollecting) return;
            
            isCollecting = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            showAlert('Monitoring started. Data uploading to cloud...', 'success');
            
            collectData();
            collectionInterval = setInterval(collectData, 2000);
        }

        function stopCollection() {
            if (!isCollecting) return;
            
            isCollecting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (collectionInterval) {
                clearInterval(collectionInterval);
                collectionInterval = null;
            }
            
            showAlert(`Monitoring stopped. ${cloudDataCount} records in cloud.`, 'info');
        }

        function downloadCSV() {
            if (dataPoints.length === 0) {
                showAlert('No data to export', 'warning');
                return;
            }

            const headers = ['timestamp', 'latitude', 'longitude', 'accuracy', 'temperature', 'windSpeed', 'aqi', 'heatIsland', 'heatDeviation', 'userId', 'sessionId'];
            const csvContent = [
                headers.join(','),
                ...dataPoints.map(dp => 
                    `${dp.timestamp},${dp.latitude},${dp.longitude},${dp.accuracy},${dp.temperature},${dp.windSpeed},${dp.aqi},${dp.heatIsland},${dp.heatDeviation},${dp.userId},${dp.sessionId}`
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `urban_air_quality_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showAlert(`Exported ${dataPoints.length} records`, 'success');
        }

        // Event Listeners
        document.getElementById('startBtn').addEventListener('click', startCollection);
        document.getElementById('stopBtn').addEventListener('click', stopCollection);
        document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

        // Initialization
        window.addEventListener('load', async () => {
            initMap();
            initCharts();
            
            try {
                await db.collection('urban_air_quality').limit(1).get();
                document.getElementById('cloudStatus').textContent = '‚óè Cloud Connected';
                showAlert('System ready. Cloud database connected.', 'info');
            } catch (error) {
                document.getElementById('cloudStatus').textContent = '‚óè Cloud Error';
                showAlert('Cloud connection issue. Local storage only.', 'warning');
            }
        });
    </script>
</body>
</html>
